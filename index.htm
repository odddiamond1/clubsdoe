<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        book: { light: '#fef3c7', DEFAULT: '#d97706', dark: '#b45309' }, // Amber
                        movie: { light: '#e0f2fe', DEFAULT: '#0ea5e9', dark: '#0369a1' }, // Sky
                        music: { light: '#f3e8ff', DEFAULT: '#9333ea', dark: '#7e22ce' }, // Purple
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            /* Subtle dot pattern */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Smooth Skeleton Loading Animation */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.375rem;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        /* Custom Scrollbar for tables */
        .custom-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-gradient-to-r from-slate-900 via-indigo-900 to-slate-900 text-white shadow-xl relative overflow-hidden">
        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
        <div class="container mx-auto px-4 py-12 relative z-10 text-center">
            <h1 class="font-serif text-5xl md:text-6xl font-bold mb-3 tracking-wide">Club Hub</h1>
            <div class="h-1 w-24 bg-indigo-400 mx-auto mb-4 rounded-full"></div>
            <p class="text-indigo-200 text-lg md:text-xl font-light tracking-wide">Books, Movies & Music</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-16 flex-grow">
        <div class="text-center mb-12">
            <h2 class="font-serif text-3xl md:text-4xl font-bold text-slate-800 mb-2">Upcoming Meetings</h2>
            <p class="text-slate-500">See what's next on the schedule</p>
        </div>

        <!-- Cards Grid -->
        <div id="club-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 items-start">
            <!-- Loading Skeletons (Initial State) -->
            <!-- These will be replaced by JS once data loads -->
            <div class="bg-white rounded-2xl p-6 shadow-lg h-96 flex flex-col gap-4">
                <div class="skeleton h-8 w-1/3"></div>
                <div class="skeleton h-6 w-3/4"></div>
                <div class="flex-grow flex gap-4">
                    <div class="skeleton w-1/3 h-full rounded-lg"></div>
                    <div class="flex-grow flex flex-col gap-2">
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-2/3"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-lg h-96 flex flex-col gap-4">
                <div class="skeleton h-8 w-1/3"></div>
                <div class="skeleton h-6 w-3/4"></div>
                <div class="flex-grow flex gap-4">
                    <div class="skeleton w-1/3 h-full rounded-lg"></div>
                    <div class="flex-grow flex flex-col gap-2">
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-2/3"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-lg h-96 flex flex-col gap-4">
                <div class="skeleton h-8 w-1/3"></div>
                <div class="skeleton h-6 w-3/4"></div>
                <div class="flex-grow flex gap-4">
                    <div class="skeleton w-1/3 h-full rounded-lg"></div>
                    <div class="flex-grow flex flex-col gap-2">
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-2/3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Previous Clubs Section -->
    <section class="bg-white border-t border-slate-200 py-16 shadow-inner">
        <div class="container mx-auto px-4">
            <div class="text-center mb-10">
                <h2 class="font-serif text-3xl font-bold text-slate-800">Archive</h2>
                <p class="text-slate-500 mt-1">Previous selections and history</p>
            </div>
            
            <div id="previous-clubs-container" class="overflow-hidden bg-white rounded-xl shadow-lg border border-slate-100 max-w-5xl mx-auto">
                <div class="overflow-x-auto custom-scroll">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Type</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Selector</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody id="previous-clubs-body" class="bg-white divide-y divide-slate-100 text-sm">
                            <!-- Rows inserted by JS -->
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-slate-400">Loading history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800">
        <div class="container mx-auto px-4 text-center">
            <div class="mb-6">
                <h3 class="font-serif text-2xl text-slate-200 font-bold tracking-wider">Club Hub</h3>
                <p class="text-sm mt-2 opacity-60">Hubbing all of your clubs in one place.</p>
            </div>
            <div class="flex justify-center space-x-6 mb-8">
                <a href="#" class="hover:text-indigo-400 transition-colors"><i class="fab fa-twitter text-xl"></i></a>
                <a href="#" class="hover:text-indigo-400 transition-colors"><i class="fab fa-instagram text-xl"></i></a>
                <a href="#" class="hover:text-indigo-400 transition-colors"><i class="fab fa-discord text-xl"></i></a>
            </div>
            <p class="text-xs text-slate-600">&copy; 2024 Club Hub. Made with <i class="fas fa-heart text-red-900 mx-1"></i> for friends.</p>
        </div>
    </footer>

    <script>
        /**
         * Club Hub Application Logic
         * Handles data fetching, processing, and rendering.
         */
        const App = {
            config: {
                sheetDbUrl: 'https://sheetdb.io/api/v1/ebdg1jebrc6wv',
                omdbKey: '7d308091',
                lastFmKey: '86e98f1783dd1af823523204bb2e2b4a'
            },

            // Mapping for UI elements based on club type
            uiConfig: {
                book: { 
                    label: 'Book Club', 
                    icon: 'fa-book-open', 
                    colorClass: 'text-book bg-book-light border-book',
                    btnClass: 'bg-book hover:bg-book-dark',
                    fallbackImg: 'https://placehold.co/400x600/FFFbeb/d97706?text=No+Cover'
                },
                movie: { 
                    label: 'Movie Club', 
                    icon: 'fa-film', 
                    colorClass: 'text-movie bg-movie-light border-movie',
                    btnClass: 'bg-movie hover:bg-movie-dark',
                    fallbackImg: 'https://placehold.co/400x600/e0f2fe/0ea5e9?text=No+Poster'
                },
                music: { 
                    label: 'Music Club', 
                    icon: 'fa-music', 
                    colorClass: 'text-music bg-music-light border-music',
                    btnClass: 'bg-music hover:bg-music-dark',
                    fallbackImg: 'https://placehold.co/400x400/f3e8ff/9333ea?text=No+Art'
                }
            },

            /**
             * Initialize the application
             */
            async init() {
                try {
                    const response = await fetch(this.config.sheetDbUrl);
                    if (!response.ok) throw new Error('Failed to fetch sheet data');
                    const rows = await response.json();
                    
                    const data = this.processData(rows);
                    this.renderCards(data.active);
                    this.renderPreviousTable(data.previous);
                    
                    // Fetch external API details for active cards
                    this.fetchDetails(data.active);

                } catch (err) {
                    console.error("Initialization Error:", err);
                    document.getElementById('club-cards').innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-exclamation-circle text-4xl text-red-400 mb-4"></i>
                            <p class="text-slate-600">Could not load club data. Please try again later.</p>
                        </div>
                    `;
                }
            },

            /**
             * Process raw sheet rows into structured data
             */
            processData(rows) {
                const active = { book: {}, movie: {}, music: {} };
                const previous = [];

                rows.forEach(row => {
                    // Active Clubs
                    if (['book', 'movie', 'music'].includes(row.type)) {
                        active[row.type] = { ...row, parsedDate: this.parseDate(row.date) };
                    }
                    // Previous Clubs
                    else if (['bookss', 'moviess', 'musics'].includes(row.type)) {
                        const cleanType = row.type.replace('ss', '').replace('cs', 'c'); // Normalize type names
                        previous.push({
                            ...row,
                            displayType: cleanType,
                            parsedDate: this.parseDate(row.date)
                        });
                    }
                });

                return { active, previous };
            },

            /**
             * Safe date parser
             */
            parseDate(dateStr) {
                if (!dateStr) return null;
                // Try standard parsing first
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) return d;
                
                // Try manual parsing for DD-MM-YYYY or similar
                const parts = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
                if (parts) {
                    // Assuming MM/DD/YYYY or DD/MM/YYYY depending on locale, 
                    // sticking to simple assumption: Month/Day/Year or try swapping if invalid
                    return new Date(parts[3], parts[1] - 1, parts[2]);
                }
                return null;
            },

            /**
             * Render the main cards
             */
            renderCards(activeData) {
                const container = document.getElementById('club-cards');
                container.innerHTML = '';

                // Convert object to array and sort by date
                const cards = Object.entries(activeData).map(([type, data]) => ({ type, ...data }));
                const today = new Date();

                cards.sort((a, b) => {
                    if (!a.parsedDate && !b.parsedDate) return 0;
                    if (!a.parsedDate) return 1;
                    if (!b.parsedDate) return -1;
                    // Sort by closest upcoming date
                    const diffA = Math.abs(a.parsedDate - today);
                    const diffB = Math.abs(b.parsedDate - today);
                    return diffA - diffB;
                });

                cards.forEach(card => {
                    const ui = this.uiConfig[card.type];
                    const dateDisplay = card.date || 'TBD';
                    const selector = card.selector || 'TBD';
                    const title = card.title || 'To Be Announced';
                    
                    // Determine which extra field to show initially (Author/Director/Artist)
                    let subTitle = '';
                    if (card.type === 'book') subTitle = card.author;
                    else if (card.type === 'music') subTitle = card.artist;
                    else if (card.type === 'movie') subTitle = 'Loading director...'; // OMDB fetches this

                    const html = `
                        <article class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden flex flex-col h-full card-hover relative group" id="card-${card.type}">
                            <!-- Top Decor Bar -->
                            <div class="h-2 w-full ${ui.btnClass}"></div>
                            
                            <div class="p-6 flex flex-col h-full">
                                <!-- Header -->
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <span class="${ui.colorClass} text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border bg-opacity-50">
                                            <i class="fas ${ui.icon} mr-1"></i> ${ui.label}
                                        </span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-slate-400 uppercase font-semibold tracking-wider">Meeting</div>
                                        <div class="font-bold text-slate-700">${dateDisplay}</div>
                                    </div>
                                </div>

                                <!-- Content Grid -->
                                <div class="flex gap-5 mb-6">
                                    <!-- Image Container with Aspect Ratio -->
                                    <div class="w-1/3 flex-shrink-0">
                                        <div class="relative w-full rounded-lg overflow-hidden shadow-md bg-slate-200 aspect-[2/3]">
                                            <img id="img-${card.type}" 
                                                 src="${ui.fallbackImg}" 
                                                 alt="${title}" 
                                                 class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500"
                                                 onload="this.classList.remove('opacity-0')"
                                                 onerror="this.src='${ui.fallbackImg}'; this.classList.remove('opacity-0')"
                                            >
                                            <!-- Skeleton Overlay -->
                                            <div id="skeleton-${card.type}" class="absolute inset-0 skeleton z-10"></div>
                                        </div>
                                    </div>

                                    <!-- Text Info -->
                                    <div class="w-2/3 flex flex-col justify-center">
                                        <h3 class="font-serif text-2xl font-bold text-slate-800 leading-tight mb-1 line-clamp-2" title="${title}">${title}</h3>
                                        <p class="text-sm font-medium text-slate-500 mb-3" id="subtitle-${card.type}">${subTitle || ''}</p>
                                        
                                        <div class="text-xs text-slate-400 mt-auto">
                                            <p class="uppercase tracking-wider font-semibold mb-1">Selected By</p>
                                            <div class="flex items-center">
                                                <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 mr-2 text-[10px]">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <span class="text-slate-600 font-medium">${selector}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dynamic Details Area -->
                                <div class="bg-slate-50 rounded-xl p-4 mb-6 flex-grow text-sm text-slate-600 leading-relaxed border border-slate-100">
                                    <div id="desc-${card.type}" class="line-clamp-4">
                                        <div class="skeleton h-3 w-full mb-2 rounded"></div>
                                        <div class="skeleton h-3 w-5/6 mb-2 rounded"></div>
                                        <div class="skeleton h-3 w-4/6 rounded"></div>
                                    </div>
                                </div>

                                <!-- Action Button -->
                                <button onclick="App.searchGoogle('${card.type}', '${title.replace(/'/g, "\\'")}', '${(subTitle || '').replace(/'/g, "\\'")}')" 
                                    class="w-full py-3 rounded-xl text-white font-medium text-sm shadow-md transition-colors ${ui.btnClass} flex items-center justify-center group-hover:shadow-lg">
                                    <span>More Info</span>
                                    <i class="fas fa-arrow-right ml-2 text-xs opacity-70 group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            </div>
                        </article>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            },

            /**
             * Fetch external data for all cards
             */
            fetchDetails(activeData) {
                // Book
                if (activeData.book && activeData.book.title) {
                    this.fetchBook(activeData.book.title);
                }
                // Movie
                if (activeData.movie && activeData.movie.title) {
                    this.fetchMovie(activeData.movie.title);
                }
                // Music
                if (activeData.music && activeData.music.title) {
                    this.fetchMusic(activeData.music.title, activeData.music.artist);
                }
            },

            async fetchBook(title) {
                const type = 'book';
                try {
                    const res = await fetch(`https://openlibrary.org/search.json?title=${encodeURIComponent(title)}`);
                    const data = await res.json();
                    
                    if (data.docs && data.docs.length > 0) {
                        const book = data.docs[0];
                        const coverUrl = book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg` : null;
                        
                        // Fetch Description
                        let desc = 'No description available.';
                        if (book.key) {
                            try {
                                const descRes = await fetch(`https://openlibrary.org${book.key}.json`);
                                const descData = await descRes.json();
                                desc = typeof descData.description === 'string' ? descData.description : descData.description?.value || desc;
                            } catch (e) { console.warn('Book description failed'); }
                        }

                        this.updateUI(type, {
                            cover: coverUrl,
                            subtitle: book.author_name?.[0],
                            description: desc,
                            meta: `${book.number_of_pages_median || '?'} pages • ${book.first_publish_year || 'Unknown'}`
                        });
                    } else {
                        this.removeSkeleton(type); // Just clear skeleton if no data
                    }
                } catch (e) {
                    console.error('Book API Error', e);
                    this.removeSkeleton(type);
                }
            },

            async fetchMovie(title) {
                const type = 'movie';
                try {
                    const res = await fetch(`https://www.omdbapi.com/?apikey=${this.config.omdbKey}&t=${encodeURIComponent(title)}`);
                    const data = await res.json();

                    if (data.Response === 'True') {
                        this.updateUI(type, {
                            cover: data.Poster !== 'N/A' ? data.Poster : null,
                            subtitle: data.Director,
                            description: data.Plot,
                            meta: `${data.Runtime} • ${data.Year}`
                        });
                    } else {
                        this.removeSkeleton(type);
                    }
                } catch (e) {
                    console.error('Movie API Error', e);
                    this.removeSkeleton(type);
                }
            },

            async fetchMusic(album, artist) {
                const type = 'music';
                try {
                    const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=album.getinfo&api_key=${this.config.lastFmKey}&artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&format=json`);
                    const data = await res.json();

                    if (data.album) {
                        const img = data.album.image.find(i => i.size === 'extralarge') || data.album.image.find(i => i.size === 'large');
                        const summary = data.album.wiki?.summary ? data.album.wiki.summary.replace(/<a.*?>.*?<\/a>/g, '') : 'No summary available.';

                        this.updateUI(type, {
                            cover: img ? img['#text'] : null,
                            subtitle: data.album.artist,
                            description: summary,
                            meta: 'Album'
                        });
                    } else {
                        this.removeSkeleton(type);
                    }
                } catch (e) {
                    console.error('Music API Error', e);
                    this.removeSkeleton(type);
                }
            },

            /**
             * Updates the DOM elements for a card and removes skeletons
             */
            updateUI(type, data) {
                if (data.cover) {
                    const img = document.getElementById(`img-${type}`);
                    if(img) img.src = data.cover;
                }
                
                this.removeSkeleton(type);

                if (data.subtitle) {
                    const el = document.getElementById(`subtitle-${type}`);
                    if(el) el.textContent = data.subtitle;
                }
                
                if (data.description) {
                    const el = document.getElementById(`desc-${type}`);
                    // Truncate description cleanly
                    const maxLength = 180;
                    let cleanDesc = data.description.length > maxLength 
                        ? data.description.substring(0, maxLength).trim() + '...' 
                        : data.description;
                    
                    // Add meta info if available (Pages/Runtime)
                    if (data.meta) {
                        cleanDesc += `<br><br><span class="text-xs font-semibold uppercase tracking-wide text-slate-400">${data.meta}</span>`;
                    }
                    
                    if(el) el.innerHTML = cleanDesc;
                }
            },

            removeSkeleton(type) {
                const skel = document.getElementById(`skeleton-${type}`);
                if (skel) skel.classList.add('hidden');
                
                const desc = document.getElementById(`desc-${type}`);
                if (desc && desc.querySelector('.skeleton')) {
                    desc.innerHTML = 'Description unavailable.';
                }
            },

            /**
             * Render the Previous Clubs table
             */
            renderPreviousTable(previousData) {
                const tbody = document.getElementById('previous-clubs-body');
                if (previousData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">No history found.</td></tr>';
                    return;
                }

                // Sort by date descending (newest first)
                previousData.sort((a, b) => {
                    const da = a.parsedDate || new Date(0);
                    const db = b.parsedDate || new Date(0);
                    return db - da;
                });

                tbody.innerHTML = previousData.map(item => {
                    const ui = this.uiConfig[item.displayType] || { label: item.displayType, icon: 'fa-circle', colorClass: 'text-gray-500 bg-gray-100' };
                    
                    return `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${ui.colorClass} bg-opacity-30">
                                    <i class="fas ${ui.icon} mr-1.5"></i> ${ui.label}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-slate-900">${item.title || '-'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-slate-500">${item.selector || '-'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                                ${item.date || '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            searchGoogle(type, title, extra) {
                let query = `${title}`;
                if (type === 'book') query += ` book ${extra || ''}`;
                else if (type === 'movie') query += ` movie`;
                else if (type === 'music') query += ` album ${extra || ''}`;
                
                window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
            }
        };

        // Start App on Load
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
